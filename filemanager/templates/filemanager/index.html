{% extends "filemanager/base.html" %}
{% block title %}My Files{% endblock %}

{% block head_extra %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
{% endblock %}

{% block content %}
<style>
    :root {
        --ss-blue: #0061f2;
        --ss-navy: #012970;
        --ss-light-blue: #e7f1ff;
        --ss-gray: #f4f6f9;
    }

    .page-content {
        padding: 30px;
        background-color: var(--ss-gray);
        min-height: 100vh;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 0 10px;
    }

    .header-icon {
        width: 50px;
        height: 50px;
        background: #e7f1ff;
        color: #0061f2;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #b3d9ff;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .header-section h1 {
        color: var(--ss-navy);
        font-weight: 800;
        margin-bottom: 5px;
        font-size: 1.8rem;
    }

    .header-section p {
        color: #6c757d;
    }

    .search-card {
        background: white;
        border-top: 4px solid var(--ss-blue);
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid #e0e6ed;
    }

    .search-form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .info-label {
        font-size: 0.75rem;
        color: #899bbd;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .form-group input[type="file"],
    .form-group input[type="text"] {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.3s;
    }

    .form-group input[type="file"]:focus,
    .form-group input[type="text"]:focus {
        border-color: var(--ss-blue);
    }

    .btn-search {
        background: var(--ss-blue);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 42px;
        white-space: nowrap;
    }

    .btn-search:hover {
        background: #004ec2;
    }

    .btn-search:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    #status {
        text-align: center;
        margin: 20px 0;
        font-size: 0.9rem;
        min-height: 20px;
        font-weight: 600;
    }

    .status-success {
        color: #155724;
    }

    .status-error {
        color: #721c24;
    }

    .status-processing {
        color: var(--ss-blue);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Results Grid */
    #results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
        padding: 0 10px;
    }

    .result-item {
        background: white;
        border: 1px solid #e0e6ed;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: zoom-in;
        aspect-ratio: 3 / 4;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .result-item:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }

    .result-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .result-item:hover img {
        transform: scale(1.05);
    }

    .result-overlay {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .result-item:hover .result-overlay {
        opacity: 1;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    /* Lightbox */
    #lightbox {
        position: fixed;
        inset: 0;
        z-index: 1000;
        background: rgba(1, 41, 112, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    #lightbox.active {
        display: flex;
    }

    .lightbox-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lightbox-image {
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .lightbox-close {
        position: absolute;
        top: 30px;
        right: 30px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
    }

    .lightbox-close:hover {
        background: #f0f0f0;
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: var(--ss-blue);
        border: none;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: background 0.3s;
        z-index: 1001;
    }

    .lightbox-nav:hover {
        background: #004ec2;
    }

    .lightbox-prev {
        left: 20px;
    }

    .lightbox-next {
        right: 20px;
    }

    .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .no-results i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 15px;
        display: block;
    }

    /* Allow clicks to pass correctly */
    #lightbox {
        pointer-events: none;
    }

    #lightbox>* {
        pointer-events: auto;
    }

    #preview-video,
    #preview-img,
    #preview-pdf {
        pointer-events: auto;
    }

    /* RESPONSIVE STYLES */
    @media (max-width: 1024px) {
        #results {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .page-content {
            padding: 20px;
        }

        .search-card {
            padding: 20px;
        }

        .search-form {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .header-section h1 {
            font-size: 1.5rem;
        }

        .max-w-7xl {
            margin-left: 10px;
            margin-right: 10px;
        }
    }

    /* ============================= */
    /* CLEAN RESPONSIVE FIX */
    /* ============================= */

    /* Page padding */
    .page-content,
    .max-w-7xl {
        padding-left: 12px;
        padding-right: 12px;
    }

    /* Top action bar wrap */
    @media (max-width: 768px) {
        .max-w-7xl>.flex.items-center.justify-between {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .max-w-7xl>.flex.items-center.justify-between>div {
            width: 100%;
        }

        .max-w-7xl input[type="text"] {
            width: 100%;
        }
    }

    /* File grid ‚Äì controlled & tappable */
    #gridView .grid {
        gap: 12px;
    }

    @media (max-width: 640px) {
        #gridView .grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .group {
            padding: 10px;
        }

        .group img {
            height: 120px;
        }

        .group button {
            padding: 6px 8px;
            font-size: 14px;
        }
    }
    #uploadProgress {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
    }
    /* List view table scroll */
    #listView {
        overflow-x: auto;
    }

    /* Lightbox mobile safety */
    @media (max-width: 640px) {

        #lightbox img,
        #lightbox video,
        #lightbox iframe {
            max-width: 95vw;
            max-height: 85vh;
        }

        #lightbox button {
            transform: scale(0.85);
        }
    }
</style>

<div class="max-w-7xl mx-auto p-6 space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <!-- SEARCH -->
        <div class="flex items-center gap-3">
            <input type="text" placeholder="Search for items"
                class="border px-4 py-2 rounded w-64 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <!-- ACTIONS -->
        <div class="flex items-center gap-3">

            <!-- UPLOAD DROPDOWN -->
            <div class="relative">
                <button onclick="toggleUploadMenu(event)"
                    class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2">
                    Upload ‚ñæ
                </button>

                <div id="uploadMenu" class="hidden absolute right-0 mt-2 bg-white border rounded shadow w-40 z-50">

                    <button onclick="triggerFileUpload()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        üìÑ Upload Files
                    </button>

                    <button onclick="triggerFolderUpload()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        üìÅ Upload Folder
                    </button>
                </div>
            </div>
            <!-- VIEW TOGGLE -->
            <div class="flex border rounded overflow-hidden">
                <button id="gridBtn" class="px-3 py-2 bg-blue-600 text-white" onclick="showGrid()">
                    ‚¨õ
                </button>
                <button id="listBtn" class="px-3 py-2 bg-white text-gray-700" onclick="showList()">
                    ‚ò∞
                </button>
            </div>

            <form id="uploadForm" enctype="multipart/form-data" class="hidden">
                {% csrf_token %}
                <input type="file" id="fileInput" name="files" multiple>
                <input type="file" id="folderInput" name="folders" webkitdirectory directory multiple>
            </form>

            <!-- NEW FOLDER -->
            <button onclick="createNewFolder()" class="ml-3 px-3 py-2 bg-white border rounded text-gray-700 hover:bg-blue-50">
                üìÅ New Folder
            </button>

            <!-- TOTAL FILES -->
            <span class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-semibold">
                Total Files {{ files|length }}
            </span>
        </div>
    </div>


    <!-- FOLDERS -->
    {% if folders %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% for folder in folders %}
        <div class="relative bg-white border rounded p-4 text-center hover:bg-blue-50">

            <!-- THREE DOT BUTTON -->
            <button type="button" class="absolute top-2 right-2 z-20 bg-white rounded-full shadow px-2"
                onclick="openFolderMenu(event, {{ folder.id }}, '{{ folder.name }}')">
                ‚ãÆ
            </button>

            <!-- FOLDER OPEN -->
            <a href="{% url 'open_folder' folder.id %}" class="block">
                üìÅ {{ folder.name }}
            </a>

        </div>
        {% endfor %}

    </div>
    {% endif %}

    <!-- FILE GRID -->
    <div id="gridView">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for f in files %}
            <div class="relative bg-white border rounded p-2 hover:shadow group">

                <!-- MENU BUTTON -->
                <button onclick="openMenu(event, {{ f.id }}, '{{ f.original_name }}', '{{ f.file.url }}')"
                    class="absolute top-2 right-2 bg-white rounded-full shadow px-2 z-10">
                    ‚ãÆ
                </button>


                <!-- MENU -->


                <!-- THUMBNAIL -->
                <div onclick="openLightbox({{ forloop.counter0 }})" class="cursor-pointer text-center">

                    {% if f.file_type == "image" and f.thumbnail %}
                    <img src="{{ f.thumbnail.url }}" class="w-full h-40 object-cover rounded">

                    {% elif f.file_type == "video" %}
                    <div class="text-5xl py-10">üé¨</div>

                    {% else %}
                    <div class="text-5xl py-10">üìÑ</div>
                    {% endif %}

                </div>

                <!-- FILE INFO -->
                <div class="mt-2 text-xs text-gray-600">
                    <p class="font-semibold truncate">{{ f.original_name }}</p>
                    <p>{{ f.file_type|upper }} </p>
                </div>

                <!-- HIDDEN DATA FOR LIGHTBOX -->
                <input type="hidden" class="file-url" value="{{ f.file.url }}">
                <input type="hidden" class="file-type" value="{{ f.file_type }}">
                <input type="hidden" class="file-name" value="{{ f.original_name }}">
                <input type="hidden" class="file-thumb" value="{% if f.thumbnail %}{{ f.thumbnail.url }}{% endif %}">
                <input type="hidden" class="file-preview" value="{% if f.preview %}{{ f.preview.url }}{% endif %}">
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="listView" class="hidden bg-white border rounded mt-4 overflow-x-auto">

        <table class="w-full text-sm">
            <thead class="bg-gray-100 text-gray-600">
                <tr>
                    <th class="text-left px-4 py-3">Name</th>
                    <th class="text-left px-4 py-3">Size</th>
                    <th class="text-left px-4 py-3">Type</th>
                    <th class="text-right px-4 py-3">Options</th>
                </tr>
            </thead>

            <tbody>
                {% for f in files %}
                <tr class="border-t hover:bg-gray-50">

                    <td class="px-4 py-3 flex items-center gap-2">
                        {% if f.file_type == "folder" %}
                        üìÅ
                        {% elif f.file_type == "image" %}
                        üñº
                        {% else %}
                        üìÑ
                        {% endif %}
                        {{ f.original_name }}
                    </td>

                

                    <td class="px-4 py-3 capitalize">
                        {{ f.file_type }}
                    </td>

                    <td class="px-4 py-3 text-right relative">

                        <!-- OPTIONS BUTTON -->
                        <button onclick="openMenu(event, {{ f.id }}, '{{ f.original_name }}', '{{ f.file.url }}')"
                            class="px-2 py-1 border rounded bg-white">
                            ‚ãÆ
                        </button>


                        <!-- MENU (SAME AS GRID) -->
                        <div id="menu-list-{{ f.id }}"
                            class="menu-box hidden absolute right-0 mt-2 bg-white border rounded shadow text-sm w-36 z-50">

                            <button onclick="renameFile({{ f.id }}, '{{ f.original_name }}')"
                                class="block w-full text-left px-3 py-2 hover:bg-gray-100">
                                ‚úè Rename
                            </button>

                            <a href="{{ f.file.url }}" download
                                class="block w-full text-left px-3 py-2 hover:bg-gray-100">
                                ‚¨á Download
                            </a>

                            <button onclick="deleteFile({{ f.id }})"
                                class="block w-full text-left px-3 py-2 text-red-600 hover:bg-red-50">
                                üóë Delete
                            </button>
                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>



</div>
<div id="uploadProgress" style="display:none"
     class="fixed bottom-6 right-6 bg-white border rounded-xl shadow-xl p-4 w-80 hidden z-50">

    <p class="text-sm font-semibold mb-1">Uploading files‚Ä¶</p>
    <p id="fileCountStatus" class="text-xs text-gray-600 mb-1">
        Files: 0 / 0
    </p>

    <p id="currentFile"
       class="text-xs text-gray-600 truncate mb-2">
        Preparing‚Ä¶
    </p>

    <div class="w-full bg-gray-200 rounded h-3 overflow-hidden">
        <div id="progressBar"
             class="bg-blue-600 h-3 transition-all duration-300"
             style="width:0%">
        </div>
    </div>  
    <!-- <div class="flex justify-end gap-2 mt-3">
        <button id="pauseBtn"
            class="px-3 py-1 border rounded text-sm"
            onclick="
                pauseUpload = true;
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('resumeBtn').classList.remove('hidden');
            ">
            ‚è∏ Pause
        </button>

        <button id="resumeBtn"
            class="px-3 py-1 bg-blue-600 text-white rounded text-sm hidden"
            onclick="
                pauseUpload = false;
                document.getElementById('resumeBtn').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
            ">
            ‚ñ∂ Resume
        </button>
    </div> -->
    <div class="flex justify-between text-xs text-gray-600 mt-2">
        <span id="uploadedSize">0 MB uploaded</span>
        <span id="remainingSize">‚Äî remaining</span>
    </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center">

    <!-- Close -->
    <button onclick="closeLightbox()"
        class="absolute top-6 right-6 bg-white rounded-full w-12 h-12 flex items-center justify-center text-xl">
        ‚úï
    </button>

    <!-- Prev -->
    <button onclick="prevFile(event)" class="absolute left-6 text-white text-5xl select-none">
        ‚Äπ
    </button>

    <!-- Next -->
    <button onclick="nextFile(event)" class="absolute right-6 text-white text-5xl select-none">
        ‚Ä∫
    </button>

    <!-- Preview Area -->
    <div class="relative max-w-[90%] max-h-[90%] pointer-events-auto">
        <img id="preview-img" class="hidden max-h-[90vh] rounded shadow-lg" />
        <video id="preview-video" class="hidden max-h-[90vh] rounded" controls playsinline>
        </video>

        <div id="video-loader" class="absolute inset-0 flex items-center justify-center bg-black/60 hidden z-50">
            <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        </div>

        <iframe id="preview-pdf" class="hidden w-[80vw] h-[90vh] bg-white rounded"></iframe>
    </div>
</div>
<!-- GLOBAL CONTEXT MENU -->
<div id="globalMenu" class="hidden fixed bg-white border rounded shadow text-sm w-36 z-[9999]">
    <button id="shareBtn" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        üîó Share
    </button>
    <button id="renameBtn" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        ‚úè Rename
    </button>
    <a id="downloadBtn" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        ‚¨á Download
    </a>

    <button id="deleteBtn" class="block w-full text-left px-3 py-2 text-red-600 hover:bg-red-50">
        üóë Delete
    </button>
</div>
<div id="folderMenu" class="hidden fixed bg-white border rounded shadow text-sm w-44 z-[9999]">

    <button onclick="openShareFolderModal()" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        üîó Share
    </button>
    <button onclick="renameFolder()" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        ‚úè Rename
    </button>

    <a id="folderDownloadBtn" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        ‚¨á Download
    </a>

    <button onclick="openPhotoAlbumModal(event)" class="block w-full text-left px-3 py-2 hover:bg-gray-100">
        üì∏ Photo Album
    </button>

    <button onclick="deleteFolder()" class="block w-full text-left px-3 py-2 text-red-600 hover:bg-red-50">
        üóë Delete
    </button>
</div>
<div id="photoAlbumModal" class="hidden fixed inset-0 bg-black/50 z-[10001] flex items-center justify-center">

    <div class="bg-white rounded-lg w-full max-w-md p-6 relative">
        <h3 class="text-lg font-semibold mb-4">Create Photo Album</h3>

        <input id="albumName" type="text" placeholder="Album Name" class="w-full border rounded px-3 py-2 mb-3" required>

        <input id="eventDate" type="date" class="w-full border rounded px-3 py-2 mb-3" required>
        <label class="block text-sm font-medium mb-1">Album Cover</label>
        <input id="albumCover" type="file" accept="image/*"
            class="w-full border rounded px-3 py-2 mb-3"
            onchange="previewAlbumCover(event)">

        <img id="coverPreview"
            class="hidden w-full h-40 object-cover rounded mb-3 border">

        <label class="flex items-center gap-2 mb-2 text-sm">
            <input type="checkbox" id="allowDownload" checked>
            Allow Download
        </label>

        <label class="block text-sm font-medium mb-1">Set PIN (4 digits)</label>
        <input id="albumPin" type="text" maxlength="4" inputmode="numeric" pattern="[0-9]{4}"
            placeholder="e.g., 1234" class="w-full border rounded px-3 py-2 mb-3" required>
        <p class="text-xs text-gray-500 mb-3">A 4-digit PIN protects the album. Users will need this to view full album.</p>

        <div class="flex justify-end gap-3">
            <button onclick="closePhotoAlbumModal()" class="px-4 py-2 border rounded">
                Cancel
            </button>

            <button onclick="submitPhotoAlbum(event)" class="px-4 py-2 bg-blue-600 text-white rounded">
                Create
            </button>
        </div>
    </div>
</div>
<div id="shareFolderModal" class="hidden fixed inset-0 bg-black/50 z-[10001] flex items-center justify-center">

    <div class="bg-white rounded-lg w-full max-w-md p-6">
        <h3 class="text-lg font-semibold mb-4">Share Folder</h3>

        <label class="flex items-center gap-2 mb-4 text-sm">
            <input type="checkbox" id="shareAllowDownload" checked>
            Allow Download
        </label>
        <input id="shareLink" type="text" readonly class="w-full border rounded px-3 py-2 mb-4 bg-gray-100">
        <div class="flex justify-end gap-3">
            <button onclick="closeShareFolderModal()" class="px-4 py-2 border rounded">
                Cancel
            </button>
            <button onclick="createShareLink()" class="px-4 py-2 bg-blue-600 text-white rounded">
                Create Link
            </button>
        </div>
    </div>
</div>

<script>
function previewAlbumCover(event) {
    const img = document.getElementById('coverPreview');
    const file = event.target.files[0];

    if (!file) {
        img.classList.add('hidden');
        return;
    }

    img.src = URL.createObjectURL(file);
    img.classList.remove('hidden');
}
</script>

<script>
    let currentFolderId = null;
    let currentFolderName = null;

    function openFolderMenu(e, folderId, folderName) {
        e.preventDefault();
        e.stopPropagation();

        currentFolderId = folderId;
        currentFolderName = folderName;

        const menu = document.getElementById("folderMenu");
        const rect = e.currentTarget.getBoundingClientRect();

        menu.style.top = rect.bottom + "px";
        menu.style.left = rect.left - 120 + "px";

        // ‚úÖ SET DOWNLOAD LINK
        document.getElementById("folderDownloadBtn").href =
            `/folders/${folderId}/download/`;

        menu.classList.remove("hidden");
    }

    function closeFolderMenu() {
        document.getElementById("folderMenu").classList.add("hidden");
    }

    // CLOSE ONLY WHEN CLICKING OUTSIDE
    document.addEventListener("click", function (e) {
        const menu = document.getElementById("folderMenu");
        if (!menu.contains(e.target)) {
            closeFolderMenu();
        }
    });
</script>

<script>
    let currentFileId = null;

    function openMenu(e, fileId, fileName, fileUrl) {
        e.stopPropagation();

        currentFileId = fileId;

        const menu = document.getElementById("globalMenu");

        // position menu near clicked button
        const rect = e.currentTarget.getBoundingClientRect();
        menu.style.top = rect.bottom + "px";
        menu.style.left = rect.right - 150 + "px";

        // wire actions
        document.getElementById("renameBtn").onclick = () => {
            renameFile(fileId, fileName);
            closeMenu();
        };

        document.getElementById("deleteBtn").onclick = () => {
            deleteFile(fileId);
            closeMenu();
        };

        document.getElementById("downloadBtn").href = fileUrl;
        document.getElementById("shareBtn").onclick = () => {
            closeMenu();
            openShareFolderModal(); // üëà new modal
        };
        menu.classList.remove("hidden");
    }
    function openShareFolderModal() {
        closeFolderMenu();
        document.getElementById("shareFolderModal").classList.remove("hidden");
    }

    function closeShareFolderModal() {
        document.getElementById("shareFolderModal").classList.add("hidden");
    }

    function createShareLink() {
        const data = new FormData();
        data.append(
            "allow_download",
            document.getElementById("shareAllowDownload").checked ? "true" : "false"
        );


        fetch(`/folders/${currentFolderId}/share/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            body: data
        })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    const input = document.getElementById("shareLink");
                    input.value = res.share_url;
                    input.select(); // ‚úÖ auto select
                } else {
                    alert(res.error || "Failed");
                }
            });

    }


    function closeMenu() {
        document.getElementById("globalMenu").classList.add("hidden");
    }

    document.addEventListener("click", closeMenu);
</script>
<script>
    let selectedFileId = null;

    function openPhotoAlbumModal(e) {
        e.stopPropagation(); // ‚úÖ CRITICAL
        closeFolderMenu();
        document.getElementById("photoAlbumModal").classList.remove("hidden");
    }

    function closePhotoAlbumModal() {
        closeFolderMenu();
        document.getElementById("photoAlbumModal").classList.add("hidden");
    }
    function submitPhotoAlbum(e) {
    e.preventDefault();
    e.stopPropagation();

    const data = new FormData();

    const albumNameVal = document.getElementById("albumName").value.trim();
    const eventDateVal = document.getElementById("eventDate").value;

    if (!albumNameVal) { alert('Album name is required'); return; }
    if (!eventDateVal) { alert('Event date is required'); return; }

    data.append("album_name", albumNameVal);
    data.append("event_date", eventDateVal);
    data.append("allow_download", document.getElementById("allowDownload").checked);

    // ‚úÖ REQUIRE PIN
    const pinVal = document.getElementById("albumPin").value.trim();
    if (!pinVal || !/^[0-9]{4}$/.test(pinVal)) {
        alert('Please enter a valid 4-digit PIN');
        return;
    }
    data.append("pin", pinVal);

    // ‚úÖ ADD COVER IMAGE (server expects 'cover_image')
    const coverInput = document.getElementById("albumCover");
    if (coverInput.files.length > 0) {
        data.append("cover_image", coverInput.files[0]);
    }

    fetch(`/folders/${currentFolderId}/share/photo-album/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken()
        },
        body: data
    })
    .then(res => res.json())
    .then(res => {
        console.log("Album response:", res);
        if (res.success) {
            alert("Photo Album created ‚úÖ");
            closePhotoAlbumModal();
            location.reload();
        } else {
            alert(res.error || "Failed");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Network error");
    });
}

</script>

<script>
    function showGrid() {
        document.getElementById("gridView").classList.remove("hidden");
        document.getElementById("listView").classList.add("hidden");

        document.getElementById("gridBtn").classList.add("bg-blue-600", "text-white");
        document.getElementById("listBtn").classList.remove("bg-blue-600", "text-white");
    }

    function showList() {
        document.getElementById("gridView").classList.add("hidden");
        document.getElementById("listView").classList.remove("hidden");

        document.getElementById("listBtn").classList.add("bg-blue-600", "text-white");
        document.getElementById("gridBtn").classList.remove("bg-blue-600", "text-white");
    }
</script>

<script>
    let pauseUpload = false;
    let uploadInProgress = false;
    function toggleUploadMenu(e) {
        e.stopPropagation();
        document.getElementById("uploadMenu").classList.toggle("hidden");
    }

    document.addEventListener("click", () => {
        document.getElementById("uploadMenu").classList.add("hidden");
    });

    function triggerFileUpload() {
        document.getElementById("fileInput").click();
    }

    function triggerFolderUpload() {
        document.getElementById("folderInput").click();
    }

    // Auto submit on selection
    document.getElementById("fileInput").addEventListener("change", submitUpload);
    document.getElementById("folderInput").addEventListener("change", submitUpload);

    async function submitUpload() {

        const files = this.files;
        if (!files.length) return;
        let totalFiles = files.length;
        let completedFiles = 0;

        document.getElementById("fileCountStatus").innerText =
            `Files: 0 / ${totalFiles}`;
        const CHUNK_SIZE = 100 * 1024 * 1024;

        {% if current_folder %}
        const parent_id = "{{ current_folder.id }}";
        {% else %}
        const parent_id = "";
        {% endif %}

        const progressBox = document.getElementById("uploadProgress");
        const bar = document.getElementById("progressBar");

        progressBox.style.display = "block";
        bar.style.width = "0%";

        function formatBytes(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB", "TB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + " " + sizes[i];
        }

        let totalBytes = 0;
        let uploadedBytes = 0;
        for (const f of files) totalBytes += f.size;

        for (const file of files) {
            const relative = file.webkitRelativePath || file.name;

            if (file.size > CHUNK_SIZE) {
                document.getElementById("currentFile").innerText =
                    `${file.name} preparing chunks‚Ä¶`;

                const chunks = Math.ceil(file.size / CHUNK_SIZE);

                const initForm = new FormData();
                initForm.append("filename", file.name);
                initForm.append("relative_path", relative);
                initForm.append("total_size", file.size);
                initForm.append("total_chunks", chunks);

                if (parent_id) {
                    initForm.append("parent_id", parent_id);   // ‚úÖ ADD THIS LINE
                }

                const initResp = await fetch("/files/upload/init/", {
                    method: "POST",
                    body: initForm,
                    headers: { "X-CSRFToken": getCSRFToken() }
                });

                const { upload_id } = await initResp.json();

                uploadInProgress = true;

                for (let i = 0; i < chunks; i++) {

                    // ‚è∏ PAUSE HERE (THIS IS THE KEY LINE)
                    while (pauseUpload) {
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }

                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);

                    document.getElementById("currentFile").innerText =
                        `${file.name} (chunk ${i + 1}/${chunks})`;

                    const blob = file.slice(start, end);
                    const chunkForm = new FormData();
                    chunkForm.append("upload_id", upload_id);
                    chunkForm.append("chunk_index", i);
                    if (parent_id) chunkForm.append("parent_id", parent_id);
                    chunkForm.append("chunk", blob);

                    await fetch("/files/upload/chunk/", {
                        method: "POST",
                        body: chunkForm,
                        headers: { "X-CSRFToken": getCSRFToken() }
                    });

                    uploadedBytes += (end - start);
                    const percent = Math.round((uploadedBytes / totalBytes) * 100);

                    bar.style.width = percent + "%";
                    document.getElementById("uploadedSize").innerText =
                        formatBytes(uploadedBytes) + " uploaded";
                    document.getElementById("remainingSize").innerText =
                        formatBytes(totalBytes - uploadedBytes) + " remaining";
                    completedFiles++;
                    document.getElementById("fileCountStatus").innerText =
                        `Files: ${completedFiles} / ${totalFiles}`;
                }
            } else {
                document.getElementById("currentFile").innerText =
                    `${file.name} uploading‚Ä¶`;

                const fd = new FormData();
                fd.append("files", file);
                fd.append(file.name, relative);
                if (parent_id) fd.append("parent_id", parent_id);

                await fetch("{% url 'upload_files' %}", {
                    method: "POST",
                    body: fd,
                    headers: { "X-CSRFToken": getCSRFToken() }
                });
                completedFiles++;
                document.getElementById("fileCountStatus").innerText =
                    `Files: ${completedFiles} / ${totalFiles}`;
                uploadedBytes += file.size;

                const percent = Math.round((uploadedBytes / totalBytes) * 100);
                bar.style.width = percent + "%";

                document.getElementById("uploadedSize").innerText =
                    formatBytes(uploadedBytes) + " uploaded";

                document.getElementById("remainingSize").innerText =
                    formatBytes(totalBytes - uploadedBytes) + " remaining";
            }
        }
        document.getElementById("currentFile").innerText =
            `Upload completed ‚úÖ (${completedFiles} files)`;
        setTimeout(() => location.reload(), 900);
    }
</script>

<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
</script>
<script>
    function renameFolder() {
        closeFolderMenu();

        const newName = prompt("Enter new folder name:", currentFolderName);
        if (!newName || newName === currentFolderName) return;

        fetch(`/folders/${currentFolderId}/rename/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: newName })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || "Rename failed");
                }
            });
    }

    function deleteFolder() {
        closeFolderMenu();

        if (!confirm("Delete this folder and all its files?")) return;

        fetch(`/folders/${currentFolderId}/delete/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken()
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || "Delete failed");
                }
            });
    }

    function createNewFolder() {
        const name = prompt("Enter new folder name:");
        if (!name) return;

        {% if current_folder %}
        const parent_id = "{{ current_folder.id }}";
        {% else %}
        const parent_id = "";
        {% endif %}


        const fd = new FormData();
        fd.append('name', name);
        if (parent_id) fd.append('parent_id', parent_id);

        fetch('/folders/create/', {
            method: 'POST',
            body: fd,
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        }).then(r => r.json()).then(data => {
            if (data.success) {
                // insert DOM node for the new folder
                const grid = document.querySelector('.grid.grid-cols-2');
                if (grid) {
                    const div = document.createElement('div');
                    div.className = 'relative bg-white border rounded p-4 text-center hover:bg-blue-50';
                    div.innerHTML = `
                        <button type="button" class="absolute top-2 right-2 z-20 bg-white rounded-full shadow px-2"
                            onclick="openFolderMenu(event, ${data.id}, '${data.name}')">
                            ‚ãÆ
                        </button>
                        <a href="/files/folder/${data.id}/" class="block">üìÅ ${data.name}</a>
                    `;
                    grid.prepend(div);
                }
            } else {
                alert(data.error || 'Could not create folder');
            }
        }).catch(() => alert('Network error'));
    }
</script>

<script>
    let files = [];
    let currentIndex = 0;
    let videoPositions = {};
    let lastVideoUrl = null;
    function showLoader() {
        document.getElementById("video-loader").classList.remove("hidden");
    }

    function hideLoader() {
        document.getElementById("video-loader").classList.add("hidden");
    }
    document.querySelectorAll(".file-url").forEach((el, i) => {
        files.push({
            url: el.value,
            thumb: document.querySelectorAll(".file-thumb")[i].value,
            preview: document.querySelectorAll(".file-preview")[i].value,
            type: document.querySelectorAll(".file-type")[i].value,
            name: document.querySelectorAll(".file-name")[i].value
        });
    });
    function toggleMenu(e, id) {
        e.stopPropagation();

        document.querySelectorAll(".menu-box").forEach(m => m.classList.add("hidden"));

        const menu = document.getElementById(`menu-${id}`);
        menu.classList.toggle("hidden");
    }
    function toggleMenu(e, id) {
        e.stopPropagation();

        document.querySelectorAll(".menu-list").forEach(m => m.classList.add("hidden"));

        const menu = document.getElementById(`menu-${id}`);
        menu.classList.toggle("hidden");
    }

    document.addEventListener("click", () => {
        document.querySelectorAll(".menu-box").forEach(m => m.classList.add("hidden"));
    });
    function renameFile(fileId, oldName) {
        event.stopPropagation();

        const newName = prompt("Enter new file name:", oldName);
        if (!newName || newName === oldName) return;

        fetch(`/files/rename/${fileId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: newName })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || "Rename failed");
                }
            });
    }

    function deleteFile(fileId) {
        event.stopPropagation();

        if (!confirm("Are you sure you want to delete this file?")) return;

        fetch(`/files/delete/${fileId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken()
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || "Delete failed");
                }
            });
    }


    function openLightbox(index) {
        currentIndex = index;
        showFile();
        document.getElementById("lightbox").classList.add("active");
        document.body.classList.add("lightbox-open");
        document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
        saveVideoTime();          // ‚úÖ SAVE FIRST
        document.getElementById("lightbox").classList.remove("active");
        document.body.classList.remove("lightbox-open");
        document.body.style.overflow = "";
        hideAll();
    }

    function nextFile(e) {
        if (e) e.stopPropagation();
        saveVideoTime();          // ‚úÖ SAVE FIRST
        currentIndex = (currentIndex + 1) % files.length;
        showFile();
    }

    function prevFile(e) {
        if (e) e.stopPropagation();
        saveVideoTime();          // ‚úÖ SAVE FIRST
        currentIndex = (currentIndex - 1 + files.length) % files.length;
        showFile();
    }


    function hideAll() {
        const vid = document.getElementById("preview-video");

        if (!vid.classList.contains("hidden") && vid.src) {
            // save exact last known correct time using index as key
            videoPositions[currentIndex] = vid.currentTime;
            vid.pause();
        }

        document.getElementById("preview-img").classList.add("hidden");
        document.getElementById("preview-video").classList.add("hidden");
        document.getElementById("preview-pdf").classList.add("hidden");
    }

    function showFile() {
        hideAll();
        const file = files[currentIndex];
        const ext = file.url.split('.').pop().toLowerCase();

        const RAW = ["cr2","cr3","nef","arw","dng","raf","orf","rw2","pef"];

        // IMAGE + RAW
        if (["jpg","jpeg","png","gif","webp"].includes(ext) || RAW.includes(ext)) {
            const img = document.getElementById("preview-img");

            if (["jpg","jpeg","png","gif","webp"].includes(ext)) {
                img.src = file.url;
            }
            else if (RAW.includes(ext)) {
                img.src = file.preview || file.thumb;
            }
            img.classList.remove("hidden");
            return;
        }

        // VIDEO
        else if (["mp4", "webm", "ogg"].includes(ext)) {
            const vid = document.getElementById("preview-video");
            const savedTime = videoPositions[currentIndex];

            // hard reset
            vid.pause();
            vid.removeAttribute("src");
            vid.load();

            vid.src = file.url;

            vid.onloadedmetadata = () => {
                if (savedTime !== undefined) {
                    vid.currentTime = savedTime;
                }
                hideLoader();
            };

            vid.onwaiting = showLoader;
            vid.onplaying = hideLoader;

            vid.classList.remove("hidden");
        }


        // PDF
        else {
            const pdf = document.getElementById("preview-pdf");
            pdf.src = "";
            pdf.src = file.url;
            pdf.classList.remove("hidden");
        }
    }
    function saveVideoTime() {
        const vid = document.getElementById("preview-video");
        if (!vid.src || vid.classList.contains("hidden")) return;

        videoPositions[currentIndex] = vid.currentTime;
        vid.pause();
    }


    document.addEventListener("keydown", function (e) {
        const lightbox = document.getElementById("lightbox");
        if (!lightbox.classList.contains("active")) return;

        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowRight") nextFile();
        if (e.key === "ArrowLeft") prevFile();
    });

</script>
{% endblock %}