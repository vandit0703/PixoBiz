<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ album.album_name }}</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: #f4f6f9;
        }
    </style>
</head>

<body class="min-h-screen">

    <div class="max-w-7xl mx-auto p-6 space-y-6">

        <!-- HEADER -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <h2 class="text-xl font-bold text-gray-800">
                ðŸ“¸ {{ album.album_name }}
                <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
                    Full Album
                </span>
            </h2>

            <div class="flex items-center gap-4">
                {% if allow_download %}
                <!-- FULL ALBUM DOWNLOAD -->
                <button onclick="startArchive()"
                    class="bg-blue-600 text-white text-sm px-4 py-2 rounded hover:bg-blue-700 font-semibold">
                    â¬‡ Download Full Album
                </button>
                {% else %}
                <span class="text-sm text-red-600 font-semibold">
                    ðŸš« Download Disabled
                </span>
                {% endif %}
            </div>
        </div>

        <!-- FILE GRID -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">

            {% for f in files %}
            <div class="bg-white border rounded p-2 hover:shadow transition">

                <!-- THUMBNAIL -->
                <div onclick="openLightbox({{ forloop.counter0 }})" class="cursor-pointer text-center">

                    {% if f.file_type == "image" and f.thumbnail %}
                    <img src="{{ f.thumbnail.url }}" class="w-full h-40 object-cover rounded">

                    {% elif f.file_type == "video" %}
                    <div class="text-5xl py-10">ðŸŽ¬</div>

                    {% else %}
                    <div class="text-5xl py-10">ðŸ“„</div>
                    {% endif %}
                </div>

                <!-- FILE INFO -->
                <div class="mt-2 text-xs text-gray-600">
                    <p class="font-semibold truncate">
                        {{ f.original_name }}
                    </p>
                    <p>{{ f.file_type|upper }}</p>
                </div>

                <!-- DOWNLOAD -->
                <div class="mt-2">
                    {% if allow_download %}
                    <a href="{% url 'public_album_file_download' share_token f.id %}"
                        class="text-blue-600 text-xs font-semibold">
                        â¬‡ Download
                    </a>
                    {% else %}
                    <span class="text-gray-400 text-xs">
                        ðŸš« Download disabled
                    </span>
                    {% endif %}

                </div>

                <!-- LIGHTBOX DATA -->
                <input type="hidden" class="file-url" value="{{ f.file.url }}">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden
            flex items-center justify-center">

        <button onclick="closeLightbox()" class="absolute top-6 right-6 bg-white
                   rounded-full w-12 h-12
                   flex items-center justify-center text-xl">
            âœ•
        </button>

        <button onclick="prevFile(event)" class="absolute left-6 text-white text-5xl select-none">
            â€¹
        </button>

        <button onclick="nextFile(event)" class="absolute right-6 text-white text-5xl select-none">
            â€º
        </button>

        <div class="relative max-w-[90%] max-h-[90%]">
            <img id="preview-img" class="hidden max-h-[90vh] rounded shadow-lg">
        </div>
    </div>

    <script>
        let files = [];
        let currentIndex = 0;

        document.querySelectorAll(".file-url").forEach((el) => {
            files.push(el.value);
        });

        function openLightbox(index) {
            currentIndex = index;
            showImage();
            document.getElementById("lightbox")
                .classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function closeLightbox() {
            document.getElementById("lightbox")
                .classList.add("hidden");
            document.body.style.overflow = "";
        }

        function nextFile(e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex + 1) % files.length;
            showImage();
        }

        function prevFile(e) {
            if (e) e.stopPropagation();
            currentIndex =
                (currentIndex - 1 + files.length) % files.length;
            showImage();
        }

        function showImage() {
            const img = document.getElementById("preview-img");
            img.src = files[currentIndex];
            img.classList.remove("hidden");
        }

        document.addEventListener("keydown", function (e) {
            const lb = document.getElementById("lightbox");
            if (lb.classList.contains("hidden")) return;
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowRight") nextFile();
            if (e.key === "ArrowLeft") prevFile();
        });
    </script>

</body>
<div id="archiveModal"
class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-xl p-6 w-96 shadow-xl">

    <h3 class="font-bold text-lg mb-3">
      Preparing Download
    </h3>

    <div class="bg-gray-200 rounded h-6">
      <div id="archiveBar"
      class="bg-blue-600 text-white text-xs text-center h-6 rounded"
      style="width:0%">0%</div>
    </div>

    <p id="archiveText"
       class="text-sm mt-3 text-gray-600">
       Startingâ€¦
    </p>

    <button id="downloadReadyBtn"
        onclick="window.location='/archive/download/'"
        class="hidden mt-4 bg-green-600 text-white px-4 py-2 rounded w-full">
        Download Now
    </button>

  </div>
</div>
</html>
<script>
    function startArchive(){

fetch("/album/{{ share_token }}/archive/start/")
.then(r=>r.json())
.then(()=>{
    document.getElementById("archiveModal")
        .classList.remove("hidden");
    pollArchive();
});
}

function pollArchive(){

fetch("/archive/progress/")
.then(r=>r.json())
.then(d=>{

    let bar = document.getElementById("archiveBar");
    let text = document.getElementById("archiveText");

    if(d.status==="processing"){
        bar.style.width = d.progress+"%";
        bar.innerText = d.progress+"%";
        text.innerText = "Preparing filesâ€¦";
        setTimeout(pollArchive, 2000);
    }

    else if(d.status==="ready"){
        bar.style.width = "100%";
        bar.innerText = "Ready";
        text.innerText = "Download ready";
        document.getElementById("downloadReadyBtn")
            .classList.remove("hidden");
    }

});
}

</script>