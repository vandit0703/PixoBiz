    {% extends "filemanager/base.html" %}
    {% block page_title %}Photo Albums{% endblock %}

    {% block content %}

    <style>
        :root {
            --blue: #0061f2;
            --navy: #012970;
            --gray: #f4f6f9;
            --border: #e0e6ed;
        }

        /* ================= PAGE ================= */
        .page-content {
            background: var(--gray);
            min-height: 100vh;
            padding: 30px;
        }

        /* ================= GRID (SMART FIX) ================= */
        .album-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
        }

        /* ================= CARD ================= */
        .album-card {
            background: #fff;
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            transition: .25s ease;
            overflow: visible;
            display: flex;
            flex-direction: column;
            height: 100%;
        }



        /* ================= IMAGE ================= */
        .album-media {
            height: 230px;
            position: relative;
            background: #e7f1ff;
            overflow: hidden;
        }

        .album-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-placeholder {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--blue);
        }

        /* ================= BODY ================= */
        .album-body {
            padding: 16px;
        }

        .album-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .album-date {
            font-size: .8rem;
            color: #6c757d;
        }

        /* ================= MENU ================= */
        .album-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
        }

        .menu-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .95);
            border: 1px solid var(--border);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-dropdown {
            position: fixed;
            /* üî• MUST BE FIXED */
            width: 190px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, .15);
            display: none;
            z-index: 999999;
            /* üöÄ unbeatable */
        }

        .album-card:hover {
            box-shadow: 0 16px 36px rgba(0, 0, 0, .12);
        }

        .menu-dropdown a {
            display: block;
            padding: 11px 14px;
            font-size: .85rem;
            color: #333;
            text-decoration: none;
        }

        .menu-dropdown a:hover {
            background: #f4f6f9;
        }

        /* ================= MODAL ================= */
        .publish-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            z-index: 999;
        }

        .publish-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 420px;
            background: #fff;
            border-radius: 14px;
            z-index: 1000;
            box-shadow: 0 25px 50px rgba(0, 0, 0, .25);
        }

        .publish-header {
            padding: 16px 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qr-box {
            padding: 20px;
            text-align: center;

            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }

        .qr-box img {
            width: 220px;
            height: 220px;
        }

        .url-box {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid #eee;
        }
        /* ===== WATERMARK GRID ===== */

        .wm-grid {
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:10px;
        }

        .wm-grid div {
            height:80px;
            border:2px dashed #cbd5e1;
            border-radius:8px;
            cursor:pointer;
            background:#f8fafc;
        }

        .wm-grid div.selected {
            border:3px solid #0061f2;
            background:#e7f1ff;
        }

        .url-box input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: .85rem;
        }

        .url-box button {
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 16px;
            font-weight: 600;
            cursor: pointer;
        }
        /* ===== LOADER ===== */

        .spinner {
            width:50px;
            height:50px;
            border:5px solid #e5e7eb;
            border-top:5px solid #0061f2;
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin:auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ================= RESPONSIVE ================= */
        @media(max-width:768px) {
            .page-content {
                padding: 16px;
            }

            .album-media {
                height: 190px;
            }
        }

        @media(max-width:480px) {
            .album-media {
                height: 160px;
            }

            .menu-dropdown {
                right: auto;
                left: 0;
                /* üî• open inward */
                width: 180px;
            }
        }
    </style>

    <div class="page-content">

        <div class="album-grid">

            {% for album in albums %}
            <div class="album-card">

                <div class="album-media">

                    <div class="album-menu">
                        <button class="menu-btn" onclick="toggleMenu(
                                event,
                                '{{ album.public_token }}',
                                '{{ album.id }}',
                                {{ album.allow_download|yesno:" true,false" }},
                                '{% url "photo_album_edit" album.id %}',
                                '{% url "photo_album_pin" album.id %}',
                                '{% url "album_customers" album.id %}',
                                '{% url "album_selected_photos" album.id %}',
                                '{% url "photo_album_delete" album.id %}')">
                            ‚ãÆ
                        </button>


                    </div>

                    <a href="{% url 'photo_album_detail' album.id %}">
                        {% if album.cover_image %}
                        <img src="{{ album.cover_image.url }}" class="album-cover">
                        {% else %}
                        <div class="album-placeholder">üì∏</div>
                        {% endif %}
                    </a>
                </div>

                <a href="{% url 'album_face_search' album.public_token %}">
                    <div class="album-body">
                        <div class="album-title truncate">{{ album.album_name }}</div>
                        <div class="album-date">{{ album.event_date }}</div>
                    </div>
                </a>

            </div>
            {% endfor %}

        </div>

    </div>
    <!-- üîê SET PIN MODAL -->
    <div id="setPinModal" style="display:none;">
        <div class="publish-overlay" onclick="closeSetPinModal()"></div>

        <div class="publish-modal">
            <div class="publish-header">
                <h3>Set Album PIN</h3>
                <button onclick="closeSetPinModal()">‚úï</button>
            </div>

            <div style="padding:20px">
                <input type="password" id="setPinInput" maxlength="4" placeholder="Enter 4-digit PIN"
                    style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;">

                <button onclick="saveAlbumPin()" style="margin-top:15px;width:100%;background:#0061f2;color:white;
                            padding:12px;border:none;border-radius:8px;font-weight:600;">
                    Save PIN
                </button>

                <p id="setPinError" style="color:red;font-size:13px;margin-top:10px;"></p>
            </div>
        </div>
    </div>

    <div id="publishModal" style="display:none;">
        <div class="publish-overlay" onclick="closePublishModal()"></div>
        <div class="publish-modal">
            <div class="publish-header">
                <h3>Publish Album URL</h3>
                <button onclick="closePublishModal()">‚úï</button>
            </div>
            <div class="qr-box">
                <img id="qrImage">

                <button onclick="downloadQR()"
                    style="
                        background:#012970;
                        color:white;
                        padding:10px 18px;
                        border:none;
                        border-radius:8px;
                        font-weight:600;
                        cursor:pointer;
                    ">
                    ‚¨á Download QR
                </button>
            </div>
            <!-- DOWNLOAD TOGGLE -->
            <!-- DOWNLOAD TYPE SELECTOR -->

            <div style="padding:0 20px 12px">

                <label style="font-weight:600;font-size:14px;">
                    Download Type
                </label>

                <label style="display:flex;gap:8px;margin-top:6px;">
                    <input type="radio" name="downloadType" value="original">
                    Original Images
                </label>

                <label style="display:flex;gap:8px;margin-top:4px;">
                    <input type="radio" name="downloadType" value="watermark">
                    Watermarked Images
                </label>

            </div>
            <div id="watermarkStatusBox" style="padding:0 20px 12px">

                {% if album.watermark_applied %}
                    <div style="color:green;font-weight:600;margin-bottom:8px">
                        ‚úÖ Watermark already applied
                    </div>

                    <button onclick="removeWatermark()"
                        style="width:100%;background:#ef4444;color:white;
                            padding:12px;border:none;border-radius:8px;font-weight:600;">
                        Remove Watermark
                    </button>

                {% else %}

                    <button onclick="openWatermarkModal()"
                        style="width:100%;background:#012970;color:white;
                            padding:12px;border:none;border-radius:8px;font-weight:600;">
                        üíß Apply Watermark
                    </button>

                {% endif %}

            </div>
            <div class="url-box">
                <input id="albumLink" readonly>
                <button onclick="copyAlbumUrl()">Copy</button>
            </div>
        </div>
    </div>
    <div class="menu-dropdown" id="globalMenu"></div>
    <!-- WATERMARK MODAL -->
    <div id="watermarkModal" style="display:none;">
        <div class="publish-overlay" onclick="closeWatermarkModal()"></div>

        <div class="publish-modal" style="width:520px">
            <div class="publish-header">
                <h3>Watermark Settings</h3>
                <button onclick="closeWatermarkModal()">‚úï</button>
            </div>

            <div style="padding:20px">

                <input type="file" id="watermarkFile"
                    accept="image/png,image/jpeg"
                    style="margin-bottom:15px">

                <div class="wm-grid">
                    <div data-pos="tl"></div>
                    <div data-pos="tc"></div>
                    <div data-pos="tr"></div>

                    <div data-pos="ml"></div>
                    <div data-pos="mc"></div>
                    <div data-pos="mr"></div>

                    <div data-pos="bl"></div>
                    <div data-pos="bc"></div>
                    <div data-pos="br"></div>
                </div>

                <button onclick="applyWatermark()"
                    style="margin-top:18px;width:100%;background:#0061f2;color:white;
                        padding:12px;border:none;border-radius:8px;font-weight:600;">
                    Apply Watermark
                </button>
                <!-- WATERMARK LOADING MODAL -->
                <div id="wmLoadingModal" style="display:none;">
                    <div class="publish-overlay"></div>

                    <div class="publish-modal" style="width:380px;text-align:center;">
                        <div style="padding:30px">

                            <div class="spinner"></div>

                            <h3 style="margin-top:15px">Applying Watermark‚Ä¶</h3>

                            <p id="wmLoadingText">
                                Processing album images. Please wait.
                            </p>

                        </div>
                    </div>
                </div>
                <p id="wmError" style="color:red;font-size:13px;margin-top:10px;"></p>
            </div>
        </div>
    </div>

    <script>
        const globalMenu = document.getElementById('globalMenu');
        let currentAlbumId = null;
        let currentAllowDownload = true;

        function toggleMenu(
            e,
            publicToken,
            albumId,
            allowDownload,
            editUrl,
            pinUrl,
            customerUrl,
            selectedUrl,
            deleteUrl
        ) {
            e.stopPropagation();

            currentAlbumId = albumId;
            currentAllowDownload = allowDownload;

            const btn = e.currentTarget.getBoundingClientRect();
            const albumUrl = `${window.location.origin}/album/${publicToken}/`;

            globalMenu.innerHTML = `
                <a href="${editUrl}">‚úè Edit</a>

                <a href="#"
                onclick="event.preventDefault(); openSetPinModal('${pinUrl}')">
                üìå Set Pin
                </a>

                <a href="#"
                onclick="event.preventDefault(); openPublishModal('${albumUrl}')">
                üîó View QR or Link
                </a>
                <a href="${selectedUrl}">‚úÖ Selected Photos</a>
                <a href="${customerUrl}">üë• View Customers</a>

                <a href="${deleteUrl}" class="text-red-600">üóë Delete</a>
            `;

            globalMenu.style.top = `${btn.bottom + 6}px`;
            globalMenu.style.left = `${Math.min(btn.left, window.innerWidth - 200)}px`;
            globalMenu.style.display = 'block';
        }

        document.addEventListener('click', () => {
            globalMenu.style.display = 'none';
        });
    </script>

    <script>
        function openPublishModal(url) {

            document.getElementById('publishModal').style.display = 'block';
            document.getElementById('albumLink').value = url;

            document.getElementById('qrImage').src =
                "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
                encodeURIComponent(url);

            // ‚úÖ bind radios NOW (modal open time)
            document.querySelectorAll("input[name=downloadType]")
            .forEach(radio => {

                radio.onchange = function () {

                    console.log("MODE CLICK:", this.value); // debug

                    if (this.value === "watermark") {
                        openWatermarkModal();
                        return;
                    }

                    fetch(`/photo-albums/${currentAlbumId}/set-download-mode/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: "mode=original"
                    });
                };
            });
        }



        function downloadQR() {
            const img = document.getElementById("qrImage");
            const link = document.createElement("a");
            link.href = img.src;
            link.download = "album_qr.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closePublishModal() {
            document.getElementById('publishModal').style.display = 'none';
        }

        function copyAlbumUrl() {
            navigator.clipboard.writeText(document.getElementById('albumLink').value);
            alert('Album link copied!');
        }
    </script>
    <script>
        let currentPinUrl = null;

        function openSetPinModal(pinUrl) {
            currentPinUrl = pinUrl;
            document.getElementById("setPinInput").value = "";
            document.getElementById("setPinError").innerText = "";
            document.getElementById("setPinModal").style.display = "block";
        }

        function closeSetPinModal() {
            document.getElementById("setPinModal").style.display = "none";
        }

        function saveAlbumPin() {
            const pin = document.getElementById("setPinInput").value;
            const errorBox = document.getElementById("setPinError");

            if (pin.length !== 4 || isNaN(pin)) {
                errorBox.innerText = "PIN must be exactly 4 digits";
                return;
            }

            fetch(currentPinUrl, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "pin=" + encodeURIComponent(pin)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closeSetPinModal();
                        alert("PIN set successfully ‚úÖ");
                    } else {
                        errorBox.innerText = data.error || "Failed to set PIN";
                    }
                })
                .catch(() => {
                    errorBox.innerText = "Server error";
                });
        }
    </script>
    <script>
    let wmPosition = null;

    function openWatermarkModal() {
        document.getElementById("watermarkModal").style.display = "block";
    }

    function closeWatermarkModal() {
        document.getElementById("watermarkModal").style.display = "none";
    }

    document.querySelectorAll(".wm-grid div").forEach(cell => {
        cell.onclick = () => {
            document.querySelectorAll(".wm-grid div")
                .forEach(c => c.classList.remove("selected"));
            cell.classList.add("selected");
            wmPosition = cell.dataset.pos;
        };
    });
    function applyWatermark() {

        const file = document.getElementById("watermarkFile").files[0];
        const error = document.getElementById("wmError");
        const btn = event.target;

        if (!file) {
            error.innerText = "Upload watermark logo";
            return;
        }

        if (!wmPosition) {
            error.innerText = "Select watermark position";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Processing...";
        document.getElementById("wmLoadingModal").style.display = "block";

        const form = new FormData();
        form.append("logo", file);
        form.append("position", wmPosition);

        fetch(`/photo-albums/${currentAlbumId}/apply-watermark/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: form
        })
        .then(r => r.json())
        .then(data => {

            if (!data.success) {
                throw new Error(data.error || "Failed");
            }

            // ‚úÖ set download mode to watermark
            return fetch(`/photo-albums/${currentAlbumId}/set-download-mode/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "mode=watermark"
            });
        })
        .then(() => {

            // ‚úÖ STOP LOADER
            document.getElementById("wmLoadingModal").style.display = "none";

            btn.disabled = false;
            btn.innerText = "Apply Watermark";

            alert("Watermark saved and enabled for download ‚úÖ");

            closeWatermarkModal();

        })
        .catch(err => {

            document.getElementById("wmLoadingModal").style.display = "none";

            btn.disabled = false;
            btn.innerText = "Apply Watermark";

            error.innerText = err.message || "Server error";
        });

    }


    </script>
    <script>
        document.querySelectorAll("input[name=downloadType]")
        .forEach(radio => {

            radio.onchange = function () {

                if (this.value === "watermark") {

                    // open watermark modal first
                    openWatermarkModal();
                    return;
                }

                // original mode ‚Äî just save
                fetch(`/photo-albums/${currentAlbumId}/set-download-mode/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "mode=original"
                });

            };

        });

        function removeWatermark() {

            fetch(`/photo-albums/${currentAlbumId}/remove-watermark/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert("Watermark removed ‚úÖ");
                    location.reload();
                }
            });

        }
    </script>
    {% endblock %}