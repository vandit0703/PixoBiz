<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shared Folder</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: #f4f6f9;
        }
    </style>
</head>

<body class="min-h-screen">

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        <!-- HEADER -->
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800">
                üìÅ {{ folder.name }}
                <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
                    Shared
                </span>
            </h2>

            {% if not allow_download %}
            <span class="text-sm text-red-600 font-semibold">
                üö´ Download Disabled
            </span>
            {% endif %}
        </div>

        <!-- SUBFOLDERS (VIEW ONLY) -->
        {% if folders %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for sub in folders %}
            <a href="{% url 'shared_folder_open' share_token sub.id %}"
                class="bg-white border rounded p-4 text-center shadow-sm hover:shadow-md transition block">

                <div class="text-3xl">üìÅ</div>
                    <div class="mt-2 font-semibold text-gray-700 truncate">
                        {{ sub.name }}
                    </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- FILE GRID -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">

            {% for f in files %}
            <div class="bg-white border rounded p-2 hover:shadow transition">

                <!-- THUMBNAIL -->
                <div onclick="openLightbox({{ forloop.counter0 }})" class="cursor-pointer text-center">

                    {% if f.file_type == "image" and f.thumbnail %}
                    <img src="{{ f.thumbnail.url }}" class="w-full h-40 object-cover rounded">

                    {% elif f.file_type == "video" %}
                    <div class="text-5xl py-10">üé¨</div>

                    {% else %}
                    <div class="text-5xl py-10">üìÑ</div>
                    {% endif %}
                </div>

                <!-- FILE INFO -->
                <div class="mt-2 text-xs text-gray-600">
                    <p class="font-semibold truncate">{{ f.original_name }}</p>
                    <p>{{ f.file_type|upper }}</p>
                </div>

                <!-- DOWNLOAD -->
                <div class="mt-2">
                    {% if allow_download %}
                    <a href="{% url 'shared_file_download' share_token f.id %}"
                        class="text-blue-600 text-xs font-semibold">
                        ‚¨á Download
                    </a>
                    {% else %}
                    <span class="text-gray-400 text-xs">
                        üö´ Download disabled
                    </span>
                    {% endif %}
                </div>

                <!-- LIGHTBOX DATA -->
                <input type="hidden" class="file-url" value="{{ f.file.url }}">
                <input type="hidden" class="file-type" value="{{ f.file_type }}">
                <input type="hidden" class="file-name" value="{{ f.original_name }}">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center">

        <!-- Close -->
        <button onclick="closeLightbox()"
            class="absolute top-6 right-6 bg-white rounded-full w-12 h-12 flex items-center justify-center text-xl">
            ‚úï
        </button>

        <!-- Prev -->
        <button onclick="prevFile(event)" class="absolute left-6 text-white text-5xl select-none">
            ‚Äπ
        </button>

        <!-- Next -->
        <button onclick="nextFile(event)" class="absolute right-6 text-white text-5xl select-none">
            ‚Ä∫
        </button>

        <!-- Preview -->
        <div class="relative max-w-[90%] max-h-[90%]">
            <img id="preview-img" class="hidden max-h-[90vh] rounded shadow-lg">
            <video id="preview-video" class="hidden max-h-[90vh] rounded" controls playsinline></video>
            <iframe id="preview-pdf" class="hidden w-[80vw] h-[90vh] bg-white rounded"></iframe>
        </div>
    </div>

    <script>
        let files = [];
        let currentIndex = 0;

        // Collect files
        document.querySelectorAll(".file-url").forEach((el, i) => {
            files.push({
                url: el.value,
                type: document.querySelectorAll(".file-type")[i].value,
                name: document.querySelectorAll(".file-name")[i].value
            });
        });

        function openLightbox(index) {
            currentIndex = index;
            showFile();
            document.getElementById("lightbox").classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function closeLightbox() {
            document.getElementById("lightbox").classList.add("hidden");
            document.body.style.overflow = "";
            hideAll();
        }

        function nextFile(e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex + 1) % files.length;
            showFile();
        }

        function prevFile(e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex - 1 + files.length) % files.length;
            showFile();
        }

        function hideAll() {
            previewImg().classList.add("hidden");
            previewVideo().classList.add("hidden");
            previewPdf().classList.add("hidden");
        }

        function showFile() {
            const file = files[currentIndex];
            const ext = file.url.split('.').pop().toLowerCase();

            hideAll();

            if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                previewImg().src = file.url;
                previewImg().classList.remove("hidden");
            }
            else if (["mp4", "webm", "ogg"].includes(ext)) {
                previewVideo().src = file.url;
                previewVideo().classList.remove("hidden");
            }
            else {
                previewPdf().src = file.url;
                previewPdf().classList.remove("hidden");
            }
        }

        function previewImg() { return document.getElementById("preview-img"); }
        function previewVideo() { return document.getElementById("preview-video"); }
        function previewPdf() { return document.getElementById("preview-pdf"); }

        // Keyboard support
        document.addEventListener("keydown", function (e) {
            const lb = document.getElementById("lightbox");
            if (lb.classList.contains("hidden")) return;
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowRight") nextFile();
            if (e.key === "ArrowLeft") prevFile();
        });
    </script>

</body>

</html>